#!/bin/bash
# Pack assets as zip payload in go executable

# Idea from Carlos Castillo (http://bit.ly/SmYXXm)

case "$1" in
    -h | --help )
        echo "usage: $(basename $0) EXECTABLE RESOURCE_DIR [ZIP OPTIONS]";
        exit;;
    --version )
        echo "nrsc version 0.3.1"; exit;;
esac

if [ $# -lt 2 ]; then
    $0 -h
    exit 1
fi

exe=$1
shift
root=$1
shift

if [ ! -f "${exe}" ]; then
    echo "error: can't find $exe"
    exit 1
fi

if [ ! -d "${root}" ]; then
    echo "error: ${root} is not a directory"
    exit 1
fi

# Exit on 1'st error
set -e

# The below is due to the retarded OSX mktemp
tmp=$(mktemp)
tmpzip=${tmp}.zip
trap "rm -f ${tmp} ${tmpzip}" EXIT

# Create zip file
(cd "${root}" && zip -r "${tmpzip}" . $@)

# Append zip to executable
cat "${tmpzip}" >> "${exe}"
# Fix zip offset in file
zip -q -A "${exe}"
